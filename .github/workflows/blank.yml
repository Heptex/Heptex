name: Build Vitamin LineageOS

on:
  workflow_dispatch:
    inputs:
      device_tree:
        description: "Device tree link"
        required: true
        default: ""
      rom_repo:
        description: "ROM repository link (with manifest)"
        required: true
        default: ""
      device_codename:
        description: "Device codename (e.g., 'vitamin')"
        required: true
        default: "vitamin"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Install prerequisites
      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-11-jdk git-core gnupg flex bison gperf build-essential zip curl zlib1g-dev \
                                  gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev \
                                  libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig \
                                  repo python3 python3-pip cmake
          echo "Installed basic prerequisites"

      # Step 2: Install ccache from source
      - name: Install ccache from source
        run: |
          cd /tmp
          wget https://github.com/ccache/ccache/releases/download/v4.8.2/ccache-4.8.2.tar.gz
          tar -xvf ccache-4.8.2.tar.gz
          cd ccache-4.8.2
          mkdir build
          cd build
          cmake ..
          make -j$(nproc)
          sudo make install
          echo 'export PATH=/usr/local/bin:$PATH' >> ~/.bashrc
          source ~/.bashrc
          ccache --version

      # Step 3: Initialize the ROM repository and sync
      - name: Initialize Vitamin LineageOS repository
        run: |
          mkdir -p $HOME/vitamin_lineage
          cd $HOME/vitamin_lineage
          git clone "${{ github.event.inputs.rom_repo }}" rom-source
          cd rom-source
          repo init -u . -b lineage-20.0
          repo sync --force-sync --no-clone-bundle --current-branch --jobs=$(nproc)
        shell: bash

      # Step 4: Clone the device tree
      - name: Clone device tree
        run: |
          cd $HOME/vitamin_lineage/rom-source
          git clone "${{ github.event.inputs.device_tree }}" device-tree
        shell: bash

      # Step 5: Build the ROM with mka bacon
      - name: Build Vitamin LineageOS with mka bacon
        run: |
          cd $HOME/vitamin_lineage/rom-source
          source build/envsetup.sh
          lunch vitamin_${{ github.event.inputs.device_codename }}-lineage-ap2a-user
          mka bacon -j$(nproc)  # Using all available CPU cores for parallelization
        shell: bash

      # Step 6: Upload the build artifacts
      - name: Upload ROM
        uses: actions/upload-artifact@v3
        with:
          name: vitamin-lineageos-build
          path: $HOME/vitamin_lineage/rom-source/out/target/product/*
